<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Happy Birthday Alisia</title>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* -------------------- åŸºç¡€æ ·å¼ -------------------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:#000;
  color:#fff;
  font-family:"Inter",sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
}

/* loading è¦†ç›–å±‚ */
#loading{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:#000;z-index:9999;
  transition:opacity .45s ease;
}
.loading-text{font-family:"Great Vibes",cursive;font-size:1.8rem;color:#a855f7;}

/* ä¸»å®¹å™¨ å¯æ»šåŠ¨ */
.container{
  height:100vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
  position:relative;
}

/* section åŸºç¡€ä¸äº®åº¦è¿‡æ¸¡ï¼ˆä¸¥æ ¼ï¼‰*/
section{
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:2rem;
  opacity:.25;
  filter:brightness(.55);
  transition:opacity .7s ease,filter .7s ease,transform .7s ease;
  transform-origin:center;
  position:relative;
  z-index:2;
}
section.active{
  opacity:1;
  filter:brightness(1);
}

/* typography */
.cursive-title{font-family:"Great Vibes",cursive}
.cursive-body{font-family:"Dancing Script",cursive}
.title-main{
  font-size:clamp(2.6rem,12vw,6.5rem);
  background:linear-gradient(45deg,#ff6b9d,#ffa500,#00d2ff,#a8ff78);
  background-size:200% 200%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:glow 2s infinite ease-in-out;
}
.title-name{
  font-size:clamp(1.6rem,8vw,4.2rem);
  color:#00d2ff;
  text-shadow:0 0 18px #00d2ff,0 0 36px #00d2ff;
}

/* wishes */
.wish-text{
  max-width:900px;
  font-size:clamp(1rem,4vw,2rem);
  text-align:center;
  opacity:0;
  transform:translateY(24px);
  transition:opacity .75s ease,transform .75s ease;
  text-shadow:0 0 16px rgba(255,255,255,.6);
}
#screen2.active .wish-text:nth-child(1){transition-delay:0s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(2){transition-delay:.12s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(3){transition-delay:.24s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(4){transition-delay:.36s;opacity:1;transform:none}

/* particle èƒŒæ™¯ï¼ˆfixedï¼‰*/
#particleBg{
  position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;
}

/* å•ä¸ªç²’å­åŸºç¡€ */
.particle{
  position:absolute;border-radius:50%;will-change:transform,opacity;
  mix-blend-mode:screen;filter:blur(.6px);
}

/* æ¸¸æˆåŒºå¸ƒå±€ */
#screen3{flex-direction:column;gap:1rem}
.controls-panel{
  width:100%;max-width:540px;background:rgba(17,24,39,.72);
  border:1px solid rgba(107,114,128,.45);
  border-radius:12px;padding:16px;backdrop-filter:blur(8px);
  text-align:center;z-index:4;margin-bottom:6px;
}
.controls-panel h3{font-family:"Great Vibes",cursive;margin-bottom:12px;font-size:1.6rem}
.input-wish{
  width:100%;padding:10px 12px;border-radius:10px;border:2px solid #a855f7;
  background:rgba(17,24,39,.9);color:#fff;font-size:15px;margin-bottom:10px;
}
.controls-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{
  padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer;background:linear-gradient(90deg,#a855f7,#ec4899);color:#fff;
  box-shadow:0 6px 18px rgba(168,85,247,.18)
}
.btn.ghost{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:#ddd}

/* è§†é¢‘åŒºåŸŸï¼šç¡®ä¿æ–‡å­—ä¸è¢«è£å‰ªä¸å¯è§æ€§ */
.video-wrapper{
  width:100%;max-width:920px;height:520px;border-radius:12px;overflow:hidden;background:#000;position:relative;
  display:flex;align-items:center;justify-content:center;z-index:3;
}
video{
  width:100%;height:100%;object-fit:cover;display:block;
}

/* wish overlay æ”¾åœ¨è§†é¢‘ä¸Šæ–¹ï¼Œå“åº”å¼å¸ƒå±€ä¿è¯ä¸é®æŒ¡æ§ä»¶ */
#wishOverlay{position:absolute;top:8%;left:50%;transform:translateX(-50%);width:90%;text-align:center;z-index:6;pointer-events:none}
.wish-display{font-size:clamp(1.1rem,3vw,1.9rem);text-shadow:0 0 18px rgba(255,255,255,.9)}
.final-message{font-size:clamp(1.4rem,3.4vw,2.6rem);background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 24px rgba(168,85,247,.6));}

/* final section */
.final-title{font-size:clamp(2.2rem,9vw,6rem);-webkit-background-clip:text;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-text-fill-color:transparent;margin-bottom:10px}

/* small screens */
@media (max-width:720px){
  .video-wrapper{height:320px}
  .controls-panel{padding:12px}
  .title-main{font-size:clamp(2rem,16vw,5rem)}
  .title-name{font-size:clamp(1.4rem,10vw,3rem)}
}

/* keyframes */
@keyframes glow{0%,100%{filter:brightness(1) drop-shadow(0 0 12px currentColor)}50%{filter:brightness(1.2) drop-shadow(0 0 26px currentColor)}}
@keyframes particleMove{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(var(--dx,20px),var(--dy,-40px),0)}}
@keyframes wishAppear{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:none}}
</style>
</head>
<body>
  <!-- Loading è¦†ç›–å±‚ -->
  <div id="loading"><div class="loading-text cursive-title">Loading Magic... âœ¨</div></div>

  <!-- ç²’å­èƒŒæ™¯ -->
  <div id="particleBg" aria-hidden="true"></div>

  <!-- ä¸»æ»šåŠ¨å®¹å™¨ -->
  <div class="container" id="mainContainer" tabindex="0">
    <!-- Screen 1 -->
    <section id="screen1" aria-label="intro">
      <div style="text-align:center;z-index:3">
        <div class="title-main cursive-title">Happy Birthday</div>
        <div class="title-name cursive-title">Alisia</div>
      </div>
    </section>

    <!-- Screen 2 -->
    <section id="screen2" aria-label="wishes">
      <div style="max-width:1000px;text-align:center">
        <p class="wish-text cursive-body">On this special day, may your smile shine as bright as the sun</p>
        <p class="wish-text cursive-body">May all the beauty and joy surround you always</p>
        <p class="wish-text cursive-body">May every dream you hold blossom in its perfect time</p>
        <p class="wish-text cursive-body">Grateful for every moment shared with you</p>
      </div>
    </section>

    <!-- Screen 3 (è§†é¢‘æ›¿ä»£ 3D) -->
    <section id="screen3" aria-label="game">
      <div class="controls-panel" id="wishPanel" role="region" aria-label="wish input">
        <h3 class="cursive-title">Make a Wish</h3>
        <input id="wishInput" class="input-wish" type="text" placeholder="Type your wish here..." aria-label="wish input" />
        <div class="controls-row">
          <button id="confirmBtn" class="btn">Confirm Wish âœ¨</button>
          <button id="preset1" class="btn ghost">Stay happy every day</button>
          <button id="preset2" class="btn ghost">Dreams come true</button>
        </div>
      </div>

      <div class="video-wrapper" id="videoWrapper" aria-live="polite">
        <video id="cakeVideo" autoplay muted playsinline preload="auto" loop>
          <source src="burn.mp4" type="video/mp4">
        </video>
        <div id="wishOverlay" aria-hidden="false"></div>
      </div>

      <div class="controls-panel" id="actionPanel" style="display:none" role="region" aria-label="actions">
        <div class="controls-row" style="justify-content:center">
          <button id="blowBtn" class="btn">Blow Out Candles ğŸŒ¬ï¸</button>
          <button id="backBtn" class="btn ghost">Go Back â†©ï¸</button>
        </div>
      </div>
    </section>

    <!-- Screen 4 -->
    <section id="screen4" aria-label="final">
      <div style="text-align:center;z-index:3">
        <div class="final-title cursive-title">May You Always Be Happy</div>
        <div class="cursive-body" style="font-size:1.1rem;color:#d1d5db">âœ¨ Happy Birthday, Dear Friend âœ¨</div>
      </div>
    </section>
  </div>

<script>
/* ===================== å®ç°è¯´æ˜ï¼ˆå†…éƒ¨æ³¨é‡Šä¸°å¯Œï¼‰ ===================== */

/* Utility: é˜²æŠ– */
function debounce(fn,wait=150){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}

/* ---------- ç²’å­èƒŒæ™¯ï¼ˆç¨³å¥ï¼‰ ---------- */
function buildParticles(){
  const container=document.getElementById('particleBg');
  container.innerHTML=''; // clear
  const isMobile = window.innerWidth < 720;
  const count = isMobile ? 60 : 140;
  const colors = ['#ff6b9d','#ffa500','#00d2ff','#a8ff78','#f093fb','#ffd166'];
  for(let i=0;i<count;i++){
    const el=document.createElement('div');
    el.className='particle';
    const size = Math.random()*6 + 2; // 2 ~ 8
    const color = colors[Math.floor(Math.random()*colors.length)];
    const left = Math.random()*100;
    const top = Math.random()*110 - 5; // allow slight peek above
    const dx = (Math.random()*2 - 1) * (10 + Math.random()*40); // move x
    const dy = -(15 + Math.random()*70); // move up
    const dur = 8 + Math.random()*18; // duration
    const delay = -(Math.random()*dur); // negative delay for natural distribution

    el.style.width = size + 'px';
    el.style.height = size + 'px';
    el.style.left = left + '%';
    el.style.top = top + '%';
    el.style.background = color;
    el.style.opacity = (0.18 + Math.random()*0.7).toFixed(2);
    el.style.boxShadow = `0 0 ${Math.max(6,size*3)}px ${color}`;
    // custom properties for movement
    el.style.setProperty('--dx', dx + 'px');
    el.style.setProperty('--dy', dy + 'px');
    el.style.animation = `particleMove ${dur}s linear ${delay}s infinite`;
    el.style.borderRadius = '50%';
    container.appendChild(el);
  }
}

/* ---------- Section äº®åº¦åŒæ­¥ï¼šIntersectionObserver ---------- */
function initSectionObserver(){
  const sections = document.querySelectorAll('section');
  const options = {
    root: null,
    rootMargin: '-25% 0px -25% 0px', // ç¡®ä¿ä¸­é—´åŒºåŸŸè§¦å‘
    threshold: [0, 0.25, 0.5, 0.75, 1]
  };
  const obs = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const el = entry.target;
      const r = entry.intersectionRatio;
      // åªæœ‰å½“å¯è§æ¯”ä¾‹ >= 0.5 æ—¶ç‚¹äº®
      if (r >= 0.5) {
        el.classList.add('active');
      } else if (r === 0) {
        // å®Œå…¨ç¦»å¼€è§†å£å†ç†„ç­
        el.classList.remove('active');
      } else {
        // ä¸­é—´éƒ¨åˆ†: ä¿æŒå½“å‰çŠ¶æ€ï¼ˆé¿å…æå‰ç‚¹äº®/é—ªçƒï¼‰
        // ä¸åšä»»ä½•æ“ä½œ
      }
    });
  }, options);
  sections.forEach(s => obs.observe(s));
}

/* ---------- è§†é¢‘é¢„åŠ è½½ä¸åŠ è½½çŠ¶æ€ç®¡ç† ---------- */
/* è¿”å› Promiseï¼Œè§†é¢‘ canplaythrough æˆ– loadeddata å³ç®—å°±ç»ª */
function waitVideoReady(videoEl, timeout=8000){
  return new Promise((resolve,reject)=>{
    let done=false;
    function onReady(){ if(done) return; done=true; cleanup(); resolve(); }
    function onErr(){ if(done) return; done=true; cleanup(); reject(new Error('video load failed')); }
    function cleanup(){
      videoEl.removeEventListener('canplaythrough', onReady);
      videoEl.removeEventListener('loadeddata', onReady);
      videoEl.removeEventListener('error', onErr);
    }
    videoEl.addEventListener('canplaythrough', onReady, {once:true});
    videoEl.addEventListener('loadeddata', onReady, {once:true});
    videoEl.addEventListener('error', onErr, {once:true});
    // timeout fallback
    setTimeout(()=>{ if(!done){ done=true; cleanup(); resolve(); } }, timeout);
  });
}

/* ---------- Wish / Controls é€»è¾‘ ---------- */
const UI = {
  wishInput: null,
  confirmBtn: null,
  preset1: null,
  preset2: null,
  wishPanel: null,
  actionPanel: null,
  blowBtn: null,
  backBtn: null,
  cakeVideo: null,
  wishOverlay: null,
  videoWrapper: null
};

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function showWish(text){
  const o = UI.wishOverlay;
  o.innerHTML = `<div class="wish-display cursive-body">${escapeHtml(text)}</div>`;
}

function clearWish(){
  UI.wishOverlay.innerHTML = '';
}

function enableControlsForConfirm(){
  UI.wishPanel.style.display = 'none';
  UI.actionPanel.style.display = 'block';
}

function resetToInput(){
  UI.wishPanel.style.display = 'block';
  UI.actionPanel.style.display = 'none';
  clearWish();
  UI.wishInput.value = '';
}

/* ç‚¹å‡»ç¡®è®¤æ„¿æœ› */
function onConfirm(){
  const v = UI.wishInput.value.trim();
  if(!v) return;
  showWish(v);
  enableControlsForConfirm();
  // ensure burn video is looping (in case previously changed)
  const video = UI.cakeVideo;
  if (video.src.indexOf('burn.mp4') === -1) {
    video.loop = true;
    video.src = 'burn.mp4';
    video.load();
    video.play().catch(()=>{});
  }
}

/* ç‚¹å‡»å¹ç­ */
function onBlow(){
  // é˜²æ­¢é‡å¤ç‚¹å‡»
  UI.blowBtn.disabled = true;
  UI.backBtn.disabled = true;

  const video = UI.cakeVideo;
  // switch to blow.mp4, do not loop
  video.loop = false;
  // For reliable change, set src then load() then play()
  video.src = 'blow.mp4';
  video.load();
  // clear overlay immediately
  clearWish();

  // Wait for loadeddata or canplaythrough, then play
  waitVideoReady(video).then(()=>{
    video.play().catch(()=>{});
  });

  // when blow video ends, show final message
  function onEnded(){
    // show final message
    UI.wishOverlay.innerHTML = `<div class="final-message cursive-title">Your wish will come true âœ¨</div>`;
    // disable blow button permanently until goBack
    UI.blowBtn.disabled = true;
    UI.backBtn.disabled = false;
    video.removeEventListener('ended', onEnded);
  }
  video.addEventListener('ended', onEnded);
}

/* ç‚¹å‡»è¿”å› */
function onBack(){
  // revert to burn, re-enable inputs
  const video = UI.cakeVideo;
  video.loop = true;
  video.src = 'burn.mp4';
  video.load();
  video.play().catch(()=>{});
  resetToInput();
  UI.blowBtn.disabled = false;
  UI.backBtn.disabled = false;
}

/* ç»‘å®š UI å…ƒç´  */
function bindUI(){
  UI.wishInput = document.getElementById('wishInput');
  UI.confirmBtn = document.getElementById('confirmBtn');
  UI.preset1 = document.getElementById('preset1');
  UI.preset2 = document.getElementById('preset2');
  UI.wishPanel = document.getElementById('wishPanel');
  UI.actionPanel = document.getElementById('actionPanel');
  UI.blowBtn = document.getElementById('blowBtn');
  UI.backBtn = document.getElementById('backBtn');
  UI.cakeVideo = document.getElementById('cakeVideo');
  UI.wishOverlay = document.getElementById('wishOverlay');
  UI.videoWrapper = document.getElementById('videoWrapper');

  UI.confirmBtn.addEventListener('click', onConfirm);
  UI.blowBtn.addEventListener('click', onBlow);
  UI.backBtn.addEventListener('click', onBack);
  UI.preset1.addEventListener('click', ()=>{ UI.wishInput.value='Stay happy every day'; });
  UI.preset2.addEventListener('click', ()=>{ UI.wishInput.value='Dreams come true'; });

  // pressing Enter when input focused confirms
  UI.wishInput.addEventListener('keypress', (e)=>{
    if(e.key === 'Enter'){ onConfirm(); e.preventDefault(); }
  });
}

/* ---------- åˆå§‹åŒ–ï¼šç­‰å¾…å…³é”®èµ„æºå‡†å¤‡åéšè— loading ---------- */
async function init(){
  // build particles and observer immediately (particles don't block)
  buildParticles();
  initSectionObserver();

  // bind UI
  bindUI();

  // wait for burn.mp4 to be ready (or timeout)
  const video = UI.cakeVideo;
  let videoReady = false;
  try{
    await waitVideoReady(video, 7000);
    videoReady = true;
  }catch(e){
    videoReady = false;
  }

  // also wait a minimal time to allow fonts/particles to appear smooth
  await new Promise(r=>setTimeout(r, 300));

  // hide loading overlay only when videoReady or after fallback timeout
  const loading = document.getElementById('loading');
  loading.style.opacity = '0';
  setTimeout(()=>{ loading.style.display = 'none'; }, 480);

  // ensure autoplay attempt
  try{ video.play().catch(()=>{}); }catch(e){}
}

/* ---------- äº‹ä»¶ï¼šresize rebuild particlesï¼ˆé˜²æŠ–ï¼‰ ---------- */
window.addEventListener('resize', debounce(()=>{ buildParticles(); }, 200));

/* ---------- å¯åŠ¨ ---------- */
window.addEventListener('load', ()=>{
  // assign UI.cakeVideo before init (used in waitVideoReady)
  UI.cakeVideo = document.getElementById('cakeVideo');
  init().catch(err=>{ console.warn('init error',err); const l=document.getElementById('loading'); l.style.opacity='0'; setTimeout(()=>l.style.display='none',480); });
});

</script>
</body>
</html>
