<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Happy Birthday Alisia</title>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:#000;
  color:#fff;
  font-family:"Inter",sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow:hidden;
}

/* Loading */
#loading{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:#000;z-index:9999;
  transition:opacity .45s ease;
}
.loading-text{font-family:"Great Vibes",cursive;font-size:1.8rem;color:#a855f7;margin-bottom:0.5rem;}
.loading-hint{font-family:"Inter",sans-serif;font-size:0.9rem;color:#9ca3af;opacity:0.7;}

/* Container */
.container{
  height:100vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
  position:relative;
}

/* Section åŸºç¡€æ ·å¼ */
section{
  min-height:100vh;
  display:flex;align-items:center;justify-content:center;
  padding:2rem;
  opacity:.25;
  filter:brightness(.55);
  transition:opacity .7s ease,filter .7s ease,transform .7s ease;
  transform-origin:center;
  position:relative;
  z-index:2;
}
section.active{
  opacity:1;
  filter:brightness(1);
}

/* Typography */
.cursive-title{font-family:"Great Vibes",cursive}
.cursive-body{font-family:"Dancing Script",cursive}
.title-main{
  font-size:clamp(2.6rem,12vw,6.5rem);
  background:linear-gradient(45deg,#ff6b9d,#ffa500,#00d2ff,#a8ff78);
  background-size:200% 200%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  animation:glow 2s infinite ease-in-out;
}
.title-name{
  font-size:clamp(1.6rem,8vw,4.2rem);
  color:#00d2ff;
  text-shadow:0 0 18px #00d2ff,0 0 36px #00d2ff;
}

/* Wishes */
.wish-text{
  max-width:900px;
  font-size:clamp(1.2rem,4vw,2.2rem);
  text-align:center;
  opacity:0;
  transform:translateY(24px);
  transition:opacity .75s ease,transform .75s ease;
  text-shadow:0 0 16px rgba(255,255,255,.6);
  margin:1rem 0;
  line-height:1.6;
}
#screen2.active .wish-text:nth-child(1){transition-delay:0s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(2){transition-delay:.15s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(3){transition-delay:.3s;opacity:1;transform:none}
#screen2.active .wish-text:nth-child(4){transition-delay:.45s;opacity:1;transform:none}

/* Particle èƒŒæ™¯ */
#particleBg{
  position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;
}
.particle{
  position:absolute;border-radius:50%;will-change:transform,opacity;
  mix-blend-mode:screen;filter:blur(.6px);
}

/* æ¸¸æˆåŒºå¸ƒå±€ */
#screen3{flex-direction:column;gap:1.5rem}
.controls-panel{
  width:100%;max-width:540px;background:rgba(17,24,39,.72);
  border:1px solid rgba(107,114,128,.45);
  border-radius:12px;padding:16px;backdrop-filter:blur(8px);
  text-align:center;z-index:4;margin-bottom:6px;
}
.controls-panel h3{font-family:"Great Vibes",cursive;margin-bottom:12px;font-size:1.8rem;
  background:linear-gradient(to right,#a855f7,#ec4899);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.input-wish{
  width:100%;padding:10px 12px;border-radius:10px;border:2px solid #a855f7;
  background:rgba(17,24,39,.9);color:#fff;font-size:15px;margin-bottom:10px;
}
.input-wish:focus{outline:none;border-color:#ec4899;box-shadow:0 0 20px rgba(236,72,153,.4)}
.controls-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.btn{
  padding:11px 16px;border-radius:10px;border:0;font-weight:600;cursor:pointer;
  background:linear-gradient(90deg,#a855f7,#ec4899);color:#fff;
  box-shadow:0 6px 18px rgba(168,85,247,.18);
  transition:transform .2s ease,box-shadow .2s ease;
}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(168,85,247,.3)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn.ghost{
  background:rgba(31,41,55,.9);
  border:1px solid rgba(75,85,99,.6);
  color:#ddd;
  box-shadow:none;
}
.btn.ghost:hover{border-color:#a855f7;background:rgba(31,41,55,1)}

/* è§†é¢‘åŒºåŸŸ - ä¿®å¤ç«–å±æ˜¾ç¤º */
.video-wrapper{
  width:100%;
  max-width:min(90vw, 600px);
  aspect-ratio:3/4;
  border-radius:12px;
  overflow:hidden;
  background:#000;
  position:relative;
  display:flex;align-items:center;justify-content:center;z-index:3;
  box-shadow:0 10px 40px rgba(0,0,0,.5);
}
video{
  width:100%;height:100%;
  object-fit:cover;
  display:block;
  background:#000;
}

/* ç”µè„‘ç«¯è§†é¢‘ä¼˜åŒ– */
@media (min-width:721px) and (min-height:800px){
  .video-wrapper{
    max-width:480px;
    max-height:640px;
  }
}

/* wish overlay */
#wishOverlay{
  position:absolute;top:8%;left:50%;transform:translateX(-50%);
  width:90%;text-align:center;z-index:6;pointer-events:none;
}
.wish-display{
  font-size:clamp(1.1rem,3vw,1.9rem);
  text-shadow:0 0 24px rgba(255,255,255,.95),0 0 48px rgba(168,85,247,.6);
  color:#fff;
  animation:wishFadeIn .8s ease-out forwards;
}
.final-message{
  font-size:clamp(1.6rem,3.8vw,2.8rem);
  background:linear-gradient(135deg,#a855f7,#ec4899,#f59e0b);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  filter:drop-shadow(0 0 28px rgba(168,85,247,.7));
  animation:wishFadeIn .8s ease-out forwards;
}

/* Final section - ä¿®å¤çƒŸèŠ±ç”»å¸ƒ */
#screen4{
  position:relative;
  overflow:hidden;
}
#screen4 > div{
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  text-align:center;z-index:10;position:relative;
}
.final-title{
  font-size:clamp(2.4rem,9vw,6.5rem);
  background:linear-gradient(135deg,#667eea,#764ba2);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  filter:drop-shadow(0 0 40px rgba(102,126,234,.6));
  margin-bottom:1.5rem;
  line-height:1.2;
}
.final-subtitle{
  font-size:clamp(1.3rem,3.5vw,2.2rem);
  color:#d1d5db;
  text-align:center;
  text-shadow:0 0 20px rgba(255,255,255,.3);
}

/* çƒŸèŠ±ç”»å¸ƒ */
#fireworksCanvas{
  position:absolute;
  top:0;left:0;
  width:100%;height:100%;
  pointer-events:none;
  z-index:5;
}

/* æ‰‹æœºç«¯ä¼˜åŒ– - ä¿ç•™åŠ¨ç”»æ•ˆæœ */
@media (max-width:720px){
  /* ç§»é™¤å¼ºåˆ¶è¦†ç›–ï¼Œè®©åŠ¨ç”»è‡ªç„¶è§¦å‘ */
  section{
    /* ä¸å†å¼ºåˆ¶ opacity:1ï¼Œè®© IntersectionObserver æ§åˆ¶ */
  }
  #screen2 .wish-text{
    /* ä¸å†å¼ºåˆ¶è¦†ç›–ï¼Œä¿ç•™è¿‡æ¸¡æ•ˆæœ */
  }
  .video-wrapper{
    max-width:90vw;
    aspect-ratio:3/4;
  }
  video{
    object-fit:contain;
  }
  .controls-panel{padding:12px}
  .title-main{font-size:clamp(2.2rem,16vw,5.5rem)}
  .title-name{font-size:clamp(1.5rem,12vw,3.5rem)}
  /* ç¡®ä¿å†…å®¹åœ¨æ‰‹æœºç«¯æœ€ç»ˆå¯è§ */
  section.active{
    opacity:1 !important;
    filter:brightness(1) !important;
  }
  #screen2.active .wish-text{
    opacity:1 !important;
    transform:none !important;
  }
}

/* keyframes */
@keyframes glow{
  0%,100%{filter:brightness(1) drop-shadow(0 0 12px currentColor)}
  50%{filter:brightness(1.2) drop-shadow(0 0 26px currentColor)}
}
@keyframes particleMove{
  0%{transform:translate3d(0,0,0)}
  100%{transform:translate3d(var(--dx,20px),var(--dy,-40px),0)}
}
@keyframes wishFadeIn{
  0%{opacity:0;transform:translateY(20px) scale(.95)}
  100%{opacity:1;transform:translateY(0) scale(1)}
}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="loading-text cursive-title">Loading Magic... âœ¨</div>
  <div class="loading-hint">(Please wait a few seconds to download all files)</div>
</div>

<!-- Particle èƒŒæ™¯ -->
<div id="particleBg" aria-hidden="true"></div>

<!-- Container -->
<div class="container" id="mainContainer" tabindex="0">

  <!-- Screen 1 -->
  <section id="screen1" aria-label="intro">
    <div style="text-align:center;z-index:3">
      <div class="title-main cursive-title">Happy Birthday</div>
      <div class="title-name cursive-title">Alisia</div>
    </div>
  </section>

  <!-- Screen 2 -->
  <section id="screen2" aria-label="wishes">
    <div style="max-width:1000px;text-align:center">
      <p class="wish-text cursive-body">On this special day, may your smile shine as bright as the sun</p>
      <p class="wish-text cursive-body">May all the beauty and joy surround you always</p>
      <p class="wish-text cursive-body">May every dream you hold blossom in its perfect time</p>
      <p class="wish-text cursive-body">Grateful for every moment shared with you</p>
    </div>
  </section>

  <!-- Screen 3 -->
  <section id="screen3" aria-label="game">
    <div class="controls-panel" id="wishPanel" role="region" aria-label="wish input">
      <h3 class="cursive-title">Make a Wish</h3>
      <input id="wishInput" class="input-wish" type="text" placeholder="Type your wish here..." aria-label="wish input" />
      <div class="controls-row">
        <button id="confirmBtn" class="btn">Confirm Wish âœ¨</button>
        <button id="preset1" class="btn ghost">Stay happy every day</button>
        <button id="preset2" class="btn ghost">Dreams come true</button>
      </div>
    </div>

    <div class="video-wrapper" id="videoWrapper" aria-live="polite">
      <video id="cakeVideo" autoplay muted playsinline preload="auto" loop>
        <source src="burn.mp4" type="video/mp4">
      </video>
      <div id="wishOverlay" aria-hidden="false"></div>
    </div>

    <div class="controls-panel" id="actionPanel" style="display:none" role="region" aria-label="actions">
      <div class="controls-row" style="justify-content:center">
        <button id="blowBtn" class="btn">ğŸŒ¬ï¸ Blow Out Candles</button>
        <button id="backBtn" class="btn ghost">â†©ï¸ Go Back</button>
      </div>
    </div>
  </section>

  <!-- Screen 4 -->
  <section id="screen4" aria-label="final">
    <canvas id="fireworksCanvas"></canvas>
    <div>
      <div class="final-title cursive-title">May You Always Be Happy</div>
      <div class="final-subtitle cursive-body">âœ¨ Happy Birthday, Dear Friend âœ¨</div>
    </div>
  </section>
</div>

<script>
function debounce(fn,wait=150){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}

function buildParticles(){
  const container=document.getElementById('particleBg'); container.innerHTML='';
  const isMobile=window.innerWidth<720; const count=isMobile?60:140;
  const colors=['#ff6b9d','#ffa500','#00d2ff','#a8ff78','#f093fb','#ffd166'];
  for(let i=0;i<count;i++){
    const el=document.createElement('div'); el.className='particle';
    const size=Math.random()*6+2; const color=colors[Math.floor(Math.random()*colors.length)];
    const left=Math.random()*100; const top=Math.random()*110-5;
    const dx=(Math.random()*2-1)*(10+Math.random()*40); const dy=-(15+Math.random()*70);
    const dur=8+Math.random()*18; const delay=-(Math.random()*dur);
    el.style.width=size+'px'; el.style.height=size+'px'; el.style.left=left+'%'; el.style.top=top+'%';
    el.style.background=color; el.style.opacity=(0.18+Math.random()*0.7).toFixed(2);
    el.style.boxShadow=`0 0 ${Math.max(6,size*3)}px ${color}`;
    el.style.setProperty('--dx',dx+'px'); el.style.setProperty('--dy',dy+'px');
    el.style.animation=`particleMove ${dur}s linear ${delay}s infinite`; el.style.borderRadius='50%';
    container.appendChild(el);
  }
}

function initSectionObserver(){
  if(!('IntersectionObserver' in window)){
    document.querySelectorAll('section').forEach(s=>activateSection(s)); return;
  }
  const sections=document.querySelectorAll('section');
  
  // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
  const isMobile = window.innerWidth < 720;
  
  // ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å®½æ¾çš„è§¦å‘æ¡ä»¶
  const options = isMobile 
    ? {root:null, rootMargin:'0px', threshold:[0, 0.1, 0.2, 0.3, 0.5, 0.7, 1]}
    : {root:null, rootMargin:'-25% 0px -25% 0px', threshold:[0, 0.25, 0.5, 0.75, 1]};
  
  const obs=new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const el=entry.target; 
      const r=entry.intersectionRatio;
      
      // ç§»åŠ¨ç«¯æ›´ä½çš„é˜ˆå€¼è§¦å‘
      const triggerThreshold = isMobile ? 0.2 : 0.5;
      
      if(r >= triggerThreshold){
        // ä½¿ç”¨å¼ºåˆ¶åŠ¨ç”»è§¦å‘æœºåˆ¶
        activateSection(el);
        
        // è§¦å‘çƒŸèŠ±
        if(el.id==='screen4' && !window.fireworksStarted){
          window.fireworksStarted=true;
          // å»¶è¿Ÿå¯åŠ¨çƒŸèŠ±ï¼Œç¡®ä¿åŠ¨ç”»å…ˆå®Œæˆ
          setTimeout(()=>initFireworks(), 300);
        }
      }else if(r===0){
        deactivateSection(el);
        
        // åœæ­¢çƒŸèŠ±
        if(el.id==='screen4'){
          window.fireworksStarted=false;
          stopFireworks();
        }
      }
    });
  },options);
  
  sections.forEach(s=>obs.observe(s));
  
  // é¡µé¢åŠ è½½æ—¶ç«‹å³æ¿€æ´»ç¬¬ä¸€å±
  const firstSection = document.getElementById('screen1');
  if(firstSection){
    setTimeout(()=>activateSection(firstSection), 100);
  }
}

// å¼ºåˆ¶åŠ¨ç”»è§¦å‘å‡½æ•° - ç¡®ä¿åŠ¨ç”»100%æ‰§è¡Œ
function activateSection(section){
  // å¦‚æœå·²ç»æ¿€æ´»ï¼Œè·³è¿‡
  if(section.classList.contains('active')) return;
  
  // 1. å…ˆç§»é™¤activeç±»ï¼Œç¡®ä¿å¤„äºåˆå§‹çŠ¶æ€
  section.classList.remove('active');
  
  // 2. å¼ºåˆ¶æµè§ˆå™¨é‡æ’ï¼ˆè§¦å‘reflowï¼‰
  void section.offsetHeight;
  
  // 3. ä½¿ç”¨åŒé‡RAFç¡®ä¿åœ¨æ­£ç¡®çš„å¸§è§¦å‘
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      section.classList.add('active');
    });
  });
}

// å¹³æ»‘é€€å‡ºåŠ¨ç”»
function deactivateSection(section){
  section.classList.remove('active');
}

// ========== çƒŸèŠ±ç³»ç»Ÿ ==========
let fireworksCanvas=null;
let fireworksCtx=null;
let fireworks=[];
let particles=[];
let animationId=null;

class Firework{
  constructor(x,y){
    this.x=x;this.y=y;this.targetY=y-Math.random()*200-150;
    this.speed=Math.random()*3+5;this.vy=-this.speed;
    this.hue=Math.random()*360;this.trail=[];this.exploded=false;
  }
  update(){
    if(!this.exploded){
      this.trail.push({x:this.x,y:this.y});
      if(this.trail.length>10)this.trail.shift();
      this.y+=this.vy;this.vy+=0.05;
      if(this.y<=this.targetY){
        this.exploded=true;
        createExplosion(this.x,this.y,this.hue);
      }
    }
    return !this.exploded;
  }
  draw(ctx){
    if(!this.exploded){
      ctx.save();
      this.trail.forEach((p,i)=>{
        const a=(i/this.trail.length)*0.8;
        ctx.fillStyle=`hsla(${this.hue},100%,70%,${a})`;
        const s=(i/this.trail.length)*3;
        ctx.fillRect(p.x-s/2,p.y-s/2,s,s);
      });
      ctx.shadowBlur=15;ctx.shadowColor=`hsl(${this.hue},100%,70%)`;
      ctx.fillStyle=`hsl(${this.hue},100%,70%)`;
      ctx.beginPath();ctx.arc(this.x,this.y,3,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }
  }
}

class Particle{
  constructor(x,y,hue){
    this.x=x;this.y=y;this.hue=hue+Math.random()*30-15;
    const a=Math.random()*Math.PI*2;const spd=Math.random()*6+2;
    this.vx=Math.cos(a)*spd;this.vy=Math.sin(a)*spd;
    this.gravity=0.08;this.friction=0.98;this.opacity=1;
    this.decay=Math.random()*0.015+0.01;this.size=Math.random()*3+2;
    this.trail=[];this.sparkle=Math.random()>0.7;
  }
  update(){
    this.trail.push({x:this.x,y:this.y,opacity:this.opacity});
    if(this.trail.length>5)this.trail.shift();
    this.vx*=this.friction;this.vy*=this.friction;this.vy+=this.gravity;
    this.x+=this.vx;this.y+=this.vy;this.opacity-=this.decay;
    return this.opacity>0;
  }
  draw(ctx){
    ctx.save();
    this.trail.forEach((p,i)=>{
      const a=(i/this.trail.length)*p.opacity*0.5;
      ctx.fillStyle=`hsla(${this.hue},100%,60%,${a})`;
      const s=(i/this.trail.length)*this.size*0.5;
      ctx.fillRect(p.x-s/2,p.y-s/2,s,s);
    });
    ctx.shadowBlur=20;ctx.shadowColor=`hsl(${this.hue},100%,60%)`;
    const grad=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size);
    grad.addColorStop(0,`hsla(${this.hue},100%,80%,${this.opacity})`);
    grad.addColorStop(0.5,`hsla(${this.hue},100%,60%,${this.opacity*0.8})`);
    grad.addColorStop(1,`hsla(${this.hue},100%,40%,0)`);
    ctx.fillStyle=grad;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

function createExplosion(x,y,hue){
  const count=Math.random()*30+50;
  for(let i=0;i<count;i++)particles.push(new Particle(x,y,hue));
  for(let i=0;i<5;i++){
    const sp=new Particle(x,y,hue);sp.size=Math.random()*4+4;sp.sparkle=true;
    particles.push(sp);
  }
}

function launchFirework(){
  if(!fireworksCanvas)return;
  const x=Math.random()*fireworksCanvas.width*0.6+fireworksCanvas.width*0.2;
  const y=fireworksCanvas.height;
  fireworks.push(new Firework(x,y));
}

function animateFireworks(){
  if(!fireworksCtx||!fireworksCanvas)return;
  fireworksCtx.fillStyle='rgba(0,0,0,0.1)';
  fireworksCtx.fillRect(0,0,fireworksCanvas.width,fireworksCanvas.height);
  if(Math.random()<0.08)launchFirework();
  fireworks=fireworks.filter(f=>{f.draw(fireworksCtx);return f.update();});
  particles=particles.filter(p=>{p.draw(fireworksCtx);return p.update();});
  animationId=requestAnimationFrame(animateFireworks);
}

function initFireworks(){
  fireworksCanvas=document.getElementById('fireworksCanvas');
  if(!fireworksCanvas)return;
  fireworksCtx=fireworksCanvas.getContext('2d');
  fireworksCanvas.width=fireworksCanvas.offsetWidth;
  fireworksCanvas.height=fireworksCanvas.offsetHeight;
  window.addEventListener('resize',()=>{
    if(fireworksCanvas){
      fireworksCanvas.width=fireworksCanvas.offsetWidth;
      fireworksCanvas.height=fireworksCanvas.offsetHeight;
    }
  });
  animateFireworks();
  setTimeout(()=>launchFirework(),500);
  setTimeout(()=>launchFirework(),800);
  setTimeout(()=>launchFirework(),1200);
}

function stopFireworks(){
  if(animationId){cancelAnimationFrame(animationId);animationId=null;}
  fireworks=[];particles=[];
}

// ========== è§†é¢‘ä¸äº¤äº’ ==========
function waitVideoReady(videoEl, timeout=8000){
  return new Promise((resolve,reject)=>{
    let done=false;
    function onReady(){if(done) return; done=true; cleanup(); resolve();}
    function onErr(){if(done) return; done=true; cleanup(); reject(new Error('video load failed'));}
    function cleanup(){videoEl.removeEventListener('canplaythrough', onReady);videoEl.removeEventListener('loadeddata', onReady);videoEl.removeEventListener('error', onErr);}
    videoEl.addEventListener('canplaythrough', onReady, {once:true}); videoEl.addEventListener('loadeddata', onReady, {once:true}); videoEl.addEventListener('error', onErr, {once:true});
    setTimeout(()=>{if(!done){done=true;cleanup();resolve();}}, timeout);
  });
}

const UI={};
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function showWish(text){UI.wishOverlay.innerHTML=`<div class="wish-display cursive-body">${escapeHtml(text)}</div>`;}
function clearWish(){UI.wishOverlay.innerHTML='';}
function enableControlsForConfirm(){UI.wishPanel.style.display='none'; UI.actionPanel.style.display='block';}
function resetToInput(){UI.wishPanel.style.display='block'; UI.actionPanel.style.display='none'; clearWish(); UI.wishInput.value='';}
function onConfirm(){const v=UI.wishInput.value.trim(); if(!v) return; showWish(v); enableControlsForConfirm(); const video=UI.cakeVideo; if(video.src.indexOf('burn.mp4')===-1){video.loop=true; video.src='burn.mp4'; video.load(); video.play().catch(()=>{});}}
function onBlow(){UI.blowBtn.disabled=true; UI.backBtn.disabled=true; const video=UI.cakeVideo; video.loop=false; video.src='blow.mp4'; video.load(); clearWish(); waitVideoReady(video).then(()=>{video.play().catch(()=>{});}); video.addEventListener('ended',function onEnded(){UI.wishOverlay.innerHTML=`<div class="final-message cursive-title">Your wish will come true âœ¨</div>`; UI.blowBtn.disabled=true; UI.backBtn.disabled=false; video.removeEventListener('ended',onEnded);});}
function onBack(){const video=UI.cakeVideo; video.loop=true; video.src='burn.mp4'; video.load(); video.play().catch(()=>{}); resetToInput(); UI.blowBtn.disabled=false; UI.backBtn.disabled=false;}
function bindUI(){
  UI.wishInput=document.getElementById('wishInput');
  UI.confirmBtn=document.getElementById('confirmBtn');
  UI.preset1=document.getElementById('preset1');
  UI.preset2=document.getElementById('preset2');
  UI.wishPanel=document.getElementById('wishPanel');
  UI.actionPanel=document.getElementById('actionPanel');
  UI.blowBtn=document.getElementById('blowBtn');
  UI.backBtn=document.getElementById('backBtn');
  UI.cakeVideo=document.getElementById('cakeVideo');
  UI.wishOverlay=document.getElementById('wishOverlay');
  UI.videoWrapper=document.getElementById('videoWrapper');

  UI.confirmBtn.addEventListener('click',onConfirm);
  UI.blowBtn.addEventListener('click',onBlow);
  UI.backBtn.addEventListener('click',onBack);
  UI.preset1.addEventListener('click',()=>{UI.wishInput.value='Stay happy every day';});
  UI.preset2.addEventListener('click',()=>{UI.wishInput.value='Dreams come true';});
  UI.wishInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'){onConfirm(); e.preventDefault();}});
}

async function init(){
  buildParticles();
  initSectionObserver();
  bindUI();
  const video=UI.cakeVideo;
  try{await waitVideoReady(video,7000);}catch(e){}
  await new Promise(r=>setTimeout(r,300));
  const loading=document.getElementById('loading');
  loading.style.opacity='0';
  setTimeout(()=>{loading.style.display='none';},500);
}

window.addEventListener('load',init);
window.addEventListener('resize',debounce(buildParticles,200));
</script>

</body>
</html>
